services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    networks:
      - lara_net
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    environment:
      - WATCHPACK_POLLING=true,
      - NODE_ENV=development
      - PYTHONUNBUFFERED=1 # Common for log flushing
      - CI=true # Sometimes tricks Next.js into standard stdout
    tty: true

  gateway_service:
    build: ./gateway_service
    ports:
      - "8002:8000" # This is the ONLY entry point for the API
    networks:
      - lara_net
      - private_net # Gateway bridges the two networks
    volumes:
      - ./gateway_service:/var/www
    environment:
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/database/database.sqlite

  auth_service:
    build: ./auth_service
    # PORTS REMOVED: No one can access this directly via localhost:8001
    networks:
      - lara_net
      - private_net
    volumes:
      - ./auth_service:/var/www
    environment:
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/database/database.sqlite
    dns:
      - 8.8.8.8
      - 8.8.4.4

  ip_management_service:
    build: ./ip_management_service
    # PORTS REMOVED: Completely hidden from the outside
    networks:
      - lara_net
      - private_net
    volumes:
      - ./ip_management_service:/var/www
    environment:
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/database/database.sqlite

networks:
  lara_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.5.0.0/16 # Uses a completely different IP range
  public_net: # Accessible to the browser/frontend
    driver: bridge
  private_net: # Completely isolated from the host
    internal: true # Optional: prevents outbound internet access for added security
    driver: bridge